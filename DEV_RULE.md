# 開発原則

## アーキテクチャパターン

### 関数型コア／命令型シェルパターン

- I/O 操作は薄いシェル層で処理し、ビジネスロジックから分離する。
- 基本は関数型プログラミング（純粋関数）で実装し、シェル層は命令型で実装する。
- テスト容易性と変更容易性を最大化する。

## アプリケーション初期化時の DI 管理

### DI コンテナによる依存関係管理

- アプリケーション起動時のみで DI コンテナを使用する。
- アプリケーションエントリーポイントで依存関係を一元管理する。
- 各サービス層では直接 DI コンテナにアクセスしない。

メリット：

- 依存関係の可視化と中央管理
- テスト時の依存関係差し替えが容易
- 循環依存の検出と防止

### ファクトリーパターンによるオブジェクト生成

- オブジェクトの生成ロジックを専用の関数に抽象化
- 依存関係を受け取って適切なインスタンスを生成

配置ルール：

- 各モジュール内: そのモジュールで使用するオブジェクトの create* 関数
- アプリケーションエントリーポイント: DIコンテナ内での依存関係組み立て

メリット：

- オブジェクト生成ロジックの抽象化・カプセル化
- 生成時の依存関係注入の制御
- テスト時の代替実装が容易

### Constructor Injection（アプリケーションレベル）

- 起動時の依存関係注入により完全なオブジェクトを構築
- クラスコンストラクタではなく、関数の引数による依存注入を基本とする

メリット：

- 依存関係の明示化
- テスト時のモック注入が容易
- 実行時エラーの早期発見

### コーディング時の DI 設計指針

- 関数の引数で依存関係を受け取る設計を基本とする
- DI コンテナへの直接アクセスを避ける（テスト容易性のため）
- 副作用を持つ処理は薄い境界層に分離し、純粋関数部分は依存注入可能にする
- モジュール間の結合度を下げるため、具象ではなく抽象に依存する

目的: テスト時に柔軟な依存関係の差し替えが可能な構造を作る

## フォルダ構成による責務分離

### interfaces/ - 外部境界層

- I/O操作と外部システムとの接続点
- 副作用を含む薄い命令型シェル + I/O関連の純粋関数
- 例：API エンドポイント、データベース接続、外部サービス連携、ファイルシステム操作
- 重要：I/O 関連の変換処理や依存処理で純粋関数化できる部分は純粋関数で実装

### core/ - ビジネスロジック層

- アプリケーションの特徴・機能実現部分
- 基本的には純粋関数で実装
- アプリの I/O 以外の副作用は場合により許容
- 例：計算ロジック、ドメインルール

### utilities/ - 汎用機能層

- I/O でもビジネスロジックでもない再利用可能な汎用機能（純粋関数）

## テスト戦略

### テストレベル別の方針

Unit Tests:

- 対象: 純粋関数部分のみ
- 副作用: テストしない（I/O 操作、外部 API 呼び出しなど）
- 依存関係: 手動モック注入（DI コンテナ不使用）
- 目的: ビジネスロジックの正確性を検証

Integration Tests:

- 対象: モジュール間の連携と副作用を含む処理
- DI コンテナ: 実際のコンテナを使用
- 外部依存: モック化（データベース、外部API等）
- 目的: システム内部の結合動作を検証

E2E Tests:

- 対象: ユーザーの実際の操作フロー
- 環境: 本番に近い環境（テスト用 DB 等）
- 外部依存: 可能な限り実際のサービス使用
- 目的: システム全体の動作を検証

### DI vs モック の使い分け

- Unit Tests: 手動モック注入による分離テスト（DI コンテナ不使用）
- Integration Tests: 実際の DI コンテナ + 外部依存のモック
- DI Container Tests: コンテナ機能自体をモック依存関係でテスト

## 設計原則

### 重視する品質属性

- テスト容易性 - 自動テストが書きやすい設計
- 変更容易性 - 変更（追加・修正・削除）しやすく、影響範囲が最小

### プログラミングパラダイム

- 関数型プログラミングを基本とする
- オブジェクト指向は除外（ライブラリ由来のクラス継承は例外）

### 一般原則

- YAGNI (You Aren't Gonna Need It) - 必要になるまで実装しない
- 単一責任の原則 - 各モジュールは一つの責務のみ
- KISS (Keep It Simple, Stupid) - シンプルさを保つ
- DRY (Don't Repeat Yourself) - 重複を避ける（意味を持つ重複は悪ではない）

## 重要な注意事項

### interfaces と core について

- interfaces = 命令型、core = 純粋関数という単純化は間違い
- 各層で適切な実装方法を選択し、可能な限り純粋関数を優先

### DIコンテナの使用制限

- アプリケーション起動時のエントリーポイントでのみ使用
- 各サービス層での直接的なコンテナアクセスは禁止
- テスト時は手動依存注入を優先
